{% extends 'base.html' %}

{% block content %}
<div class="relative">
    <div class="absolute top-3 right-3 bg-stone-100 rounded-lg shadow-md p-4 z-10">
        <div class="flex justify-end mb-1">
            <div class="text-indigo-800 font-semibold">
                <i class="fas fa-stopwatch mr-2"></i><span id="timer" class="text-xl">00:00</span>
            </div>
        </div>
       
        <div class="flex flex-col items-end space-y-2">
            <div class="text-indigo-800 font-semibold">
                <i class="fas fa-trophy mr-2"></i>Sequência: <span id="streak" class="text-xl">0</span>
            </div>
            <div class="text-green-400 font-semibold">
                <i class="fas fa-check-circle mr-2"></i>Acertos: <span id="correct" class="text-xl">0</span>
            </div>
            <div class="text-red-400 font-semibold">
                <i class="fas fa-times-circle mr-2"></i>Erros: <span id="incorrect" class="text-xl">0</span>
            </div>
        </div>
    </div>
</div>
<section class="bg-white rounded-lg shadow-md p-6 mt-10 relative">
    <div class="flex flex-col gap-3 items-center mb-6">
        <h2 class="text-2xl font-bold text-indigo-800 flex items-center">
            <i class="fas fa-puzzle-piece mr-3 text-indigo-600"></i>
            Desafio de Frases Embaralhadas
        </h2>
        <button id="play-audio" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center">
            <i class="fas fa-volume-up text-xl mr-2"></i>
            Ouvir
        </button>
    </div>
   
    <div id="exercise-area" class="mb-6">
        <div class="p-6 rounded-lg mb-6">
            <h3 class="text-lg font-semibold text-indigo-800 mb-5">Lorem rela lores</h3>
            <div id="word-container" class="w-full flex flex-wrap justify-center gap-3 mb-6"></div>
        </div>
       
        <div class="flex justify-center space-x-4 mb-4">
            <button id="check-answer" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center">
                <i class="fas fa-check mr-2"></i> Verificar
            </button>
            <button id="skip-exercise" class="bg-yellow-500 text-white px-6 py-2 rounded-md hover:bg-yellow-600 transition duration-300 flex items-center">
                <i class="fas fa-forward mr-2"></i> Pular exercício
            </button>
        </div>
       
        <div id="result-message" class="text-center font-bold mt-4"></div>
    </div>
   
    <button id="start-exercise" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center">
        <i class="fas fa-play mr-2"></i> Iniciar Desafio
    </button>
    <div class="absolute bottom-4 left-4 cursor-pointer" id="help-icon">
        <i class="fas fa-question-circle text-2xl text-indigo-600"></i>
    </div>
    <div id="help-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Como jogar</h3>
                <div class="mt-2 px-7 py-3">
                    <ol class="list-decimal list-inside text-gray-700 text-left">
                        <li>Leia as palavras embaralhadas</li>
                        <li>Clique nas palavras na ordem correta</li>
                        <li>Verifique sua resposta ou pule para o próximo desafio</li>
                    </ol>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block script %}
<script>
    const sentences = [
        'How are you today? I hope you are doing well.',
        'What is your name? I would love to get to know you better.',
        'Where do you live? It must be a wonderful place.',
        'I like learning languages. It opens up so many opportunities.',
        'The weather is nice today. Perfect for a walk in the park.',
        'Can you help me please? I would really appreciate your assistance.',
        'I enjoy traveling to new places. Exploring the world is my passion.',
        'Music is a universal language. It connects people from all walks of life.',
        'Reading books expands your mind. It’s like traveling without leaving home.',
        'Practice makes perfect. Consistency is the key to mastering any skill.'
    ];

    let currentSentence = '';
    let selectedWords = [];
    let streak = 0;
    let correct = 0;
    let incorrect = 0;
    let timerInterval;
    let seconds = 0;
    let totalExercises = 0;
    let correctExercises = 0;

    function startExercise() {
        currentSentence = sentences[Math.floor(Math.random() * sentences.length)];
        const words = currentSentence.split(' ').sort(() => Math.random() - 0.5);
        
        const wordContainer = document.getElementById('word-container');
        wordContainer.innerHTML = '';
        selectedWords = [];

        words.forEach(word => {
            const wordElement = document.createElement('div');
            wordElement.textContent = word;
            wordElement.className = 'bg-white p-3 rounded-lg cursor-pointer hover:bg-indigo-200 transition duration-300 shadow-md border border-indigo-200 text-indigo-800 font-medium';
            wordElement.addEventListener('click', () => toggleWordSelection(wordElement));
            wordContainer.appendChild(wordElement);
        });

        document.getElementById('exercise-area').classList.remove('hidden');
        document.getElementById('result-message').textContent = '';
        document.getElementById('start-exercise').classList.add('hidden');

        // Reiniciar o timer
        clearInterval(timerInterval);
        seconds = 0;
        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);

        totalExercises++;
        updateProgress();
    }

    function toggleWordSelection(wordElement) {
        if (wordElement.classList.contains('bg-indigo-300')) {
            wordElement.classList.remove('bg-indigo-300');
            selectedWords = selectedWords.filter(word => word !== wordElement.textContent);
        } else {
            wordElement.classList.add('bg-indigo-300');
            selectedWords.push(wordElement.textContent);
        }
    }

    function checkAnswer() {
        const userAnswer = selectedWords.join(' ');
        const resultMessage = document.getElementById('result-message');
        
        if (userAnswer === currentSentence) {
            resultMessage.textContent = 'Correto! Parabéns!';
            resultMessage.className = 'mt-4 text-center font-bold text-green-600';
            streak++;
            correct++;
            correctExercises++;
        } else {
            resultMessage.textContent = 'Incorreto. Tente novamente!';
            resultMessage.className = 'mt-4 text-center font-bold text-red-600';
            streak = 0;
            incorrect++;
        }

        document.getElementById('streak').textContent = streak;
        document.getElementById('correct').textContent = correct;
        document.getElementById('incorrect').textContent = incorrect;
        updateProgress();
        clearInterval(timerInterval);
    }

    function updateTimer() {
        seconds++;
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function updateProgress() {
        const progressPercentage = (correctExercises / totalExercises) * 100;
        document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
        document.getElementById('progress-text').textContent = 
            `${correctExercises} de ${totalExercises} exercícios concluídos (${Math.round(progressPercentage)}%)`;
    }

    document.getElementById('start-exercise').addEventListener('click', startExercise);
    document.getElementById('check-answer').addEventListener('click', checkAnswer);
    document.getElementById('skip-exercise').addEventListener('click', startExercise);

    // Modal de ajuda
    const helpIcon = document.getElementById('help-icon');
    const helpModal = document.getElementById('help-modal');
    const closeModal = document.getElementById('close-modal');

    helpIcon.addEventListener('click', () => {
        helpModal.classList.remove('hidden');
    });

    closeModal.addEventListener('click', () => {
        helpModal.classList.add('hidden');
    });

    // Fechar o modal se clicar fora dele
    window.addEventListener('click', (event) => {
        if (event.target === helpModal) {
            helpModal.classList.add('hidden');
        }
    });

    // Iniciar o primeiro exercício automaticamente
    startExercise();
</script>
{% endblock %}